{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <!-- Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bot-icon me-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary">
                                <rect width="18" height="10" x="3" y="11" rx="2"/>
                                <circle cx="12" cy="5" r="2"/>
                                <path d="M12 7v4"/>
                                <line x1="8" x2="8" y1="16" y2="16"/>
                                <line x1="16" x2="16" y1="16" y2="16"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="mb-0">WrestleBot AI</h1>
                            <p class="text-muted mb-0">Our AI-Powered Research Assistant</p>
                        </div>
                        <div class="ms-auto text-end">
                            <span class="badge bg-{{ status_class }} fs-6">
                                {% if status == 'active' %}Working
                                {% elif status == 'paused' %}Resting
                                {% else %}Online{% endif %}
                            </span>
                        </div>
                    </div>

                    <p class="lead mb-0">
                        WrestleBot is our tireless AI assistant that works around the clock to build the most
                        comprehensive wrestling database ever created. It automatically finds and organizes
                        information about wrestlers, events, matches, and championships from across the internet.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4 col-6 mb-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-0">{{ stats.total_added|default:0 }}</h3>
                    <small class="text-muted">Records Added</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-6 mb-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <h3 class="text-success mb-0">{{ recent_creates_24h|default:0 }}</h3>
                    <small class="text-muted">Added Today</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-12 mb-3">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body text-center">
                    <h3 class="text-info mb-0">24/7</h3>
                    <small class="text-muted">Always Working</small>
                </div>
            </div>
        </div>
    </div>

    <!-- What WrestleBot Does -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h4 class="mb-0">What WrestleBot Does</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4 mb-md-0">
                            <div class="d-flex mb-3">
                                <div class="feature-icon me-3 text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                </div>
                                <div>
                                    <h5>Discovers New Data</h5>
                                    <p class="text-muted mb-0">Finds wrestlers, events, and matches from trusted sources across the web, then adds them to our database.</p>
                                </div>
                            </div>
                            <div class="d-flex mb-3">
                                <div class="feature-icon me-3 text-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                                </div>
                                <div>
                                    <h5>Verifies Information</h5>
                                    <p class="text-muted mb-0">Cross-checks facts from multiple sources to ensure accuracy and reliability.</p>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="feature-icon me-3 text-warning">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                                </div>
                                <div>
                                    <h5>Enriches Profiles</h5>
                                    <p class="text-muted mb-0">Adds photos, biographical details, and connections between wrestlers, promotions, and events.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex mb-3">
                                <div class="feature-icon me-3 text-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>
                                </div>
                                <div>
                                    <h5>Updates Automatically</h5>
                                    <p class="text-muted mb-0">Keeps the database fresh by checking for new events and results every day.</p>
                                </div>
                            </div>
                            <div class="d-flex mb-3">
                                <div class="feature-icon me-3 text-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                </div>
                                <div>
                                    <h5>Respects Sources</h5>
                                    <p class="text-muted mb-0">Only collects factual data (names, dates, results) and always credits where information comes from.</p>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="feature-icon me-3 text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                </div>
                                <div>
                                    <h5>Connects Everything</h5>
                                    <p class="text-muted mb-0">Links wrestlers to their matches, stables, championships, and career history.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Currently Tracking -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h4 class="mb-0">Currently Tracking</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-3">
                        {% if config.focus_wrestlers %}
                        <div class="tracking-badge">
                            <span class="badge bg-primary p-2 fs-6">Wrestlers</span>
                        </div>
                        {% endif %}
                        {% if config.focus_promotions %}
                        <div class="tracking-badge">
                            <span class="badge bg-success p-2 fs-6">Promotions</span>
                        </div>
                        {% endif %}
                        {% if config.focus_events %}
                        <div class="tracking-badge">
                            <span class="badge bg-info p-2 fs-6">Events</span>
                        </div>
                        {% endif %}
                        {% if config.focus_titles %}
                        <div class="tracking-badge">
                            <span class="badge bg-warning text-dark p-2 fs-6">Championships</span>
                        </div>
                        {% endif %}
                        {% if config.focus_matches %}
                        <div class="tracking-badge">
                            <span class="badge bg-danger p-2 fs-6">Matches</span>
                        </div>
                        {% endif %}
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        WrestleBot is currently focused on these categories. It works continuously in the
                        background to grow our database while you browse.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h4 class="mb-0">Recent Discoveries</h4>
                </div>
                <div class="card-body">
                    {% if logs %}
                    <div class="row">
                        {% for log in logs|slice:":12" %}
                        <div class="col-md-4 col-6 mb-3">
                            <div class="discovery-item d-flex align-items-center">
                                {% if log.action_type == 'create' %}
                                <span class="badge bg-success me-2">New</span>
                                {% elif log.action_type == 'update' %}
                                <span class="badge bg-info me-2">Updated</span>
                                {% else %}
                                <span class="badge bg-secondary me-2">Found</span>
                                {% endif %}
                                <div>
                                    <strong>{{ log.entity_name|truncatechars:25 }}</strong>
                                    <br><small class="text-muted">{{ log.entity_type|title }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted mb-3">
                            <rect width="18" height="10" x="3" y="11" rx="2"/>
                            <circle cx="12" cy="5" r="2"/>
                            <path d="M12 7v4"/>
                            <line x1="8" x2="8" y1="16" y2="16"/>
                            <line x1="16" x2="16" y1="16" y2="16"/>
                        </svg>
                        <h5 class="text-muted">Getting Started</h5>
                        <p class="text-muted mb-0">WrestleBot is warming up and will start discovering data soon!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if is_staff %}
    <!-- Admin Controls (staff only) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Admin Controls</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>System Health</h6>
                            <div class="d-flex gap-2 mb-3">
                                <span class="badge {% if health.redis %}bg-success{% else %}bg-danger{% endif %}">Redis: {% if health.redis %}OK{% else %}Down{% endif %}</span>
                                <span class="badge {% if health.celery %}bg-success{% else %}bg-danger{% endif %}">Celery: {% if health.celery %}OK{% else %}Down{% endif %}</span>
                                <span class="badge {% if health.ollama %}bg-success{% else %}bg-warning text-dark{% endif %}">AI: {% if health.ollama %}{{ config.ai_model_name }}{% else %}Fallback{% endif %}</span>
                            </div>
                            <p class="text-muted small mb-0">
                                Rate: {{ stats.added_this_hour }}/{{ config.max_items_per_hour }} this hour,
                                {{ stats.added_today }}/{{ config.max_items_per_day }} today
                            </p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button class="btn btn-warning" onclick="triggerDiscovery()" id="triggerBtn" {% if not health.celery %}disabled{% endif %}>
                                Run Discovery Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if is_staff %}
<script>
async function triggerDiscovery() {
    const btn = document.getElementById('triggerBtn');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Running...';

    try {
        const response = await fetch('/api/wrestlebot/trigger/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.cookie.split(';').find(c => c.trim().startsWith('csrftoken=')).split('=')[1]
            },
            body: 'max_items=15'
        });

        const data = await response.json();
        if (data.success) {
            btn.textContent = 'Triggered!';
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Failed: ' + (data.error || 'Unknown error'));
            btn.textContent = 'Run Discovery Now';
            btn.disabled = false;
        }
    } catch (error) {
        alert('Failed to trigger');
        btn.textContent = 'Run Discovery Now';
        btn.disabled = false;
    }
}
</script>
{% endif %}
{% endblock %}
